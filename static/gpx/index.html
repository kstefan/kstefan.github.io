<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Merge two GPX files (tracks + waypoints)</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 2rem;
        }

        label {
            display: block;
            margin: 0.5rem 0;
        }

        button {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
        }

        pre {
            background: #f4f4f4;
            padding: 0.5rem;
            max-height: 200px;
            overflow: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
<h1>Merge two GPX files</h1>

<label>
    GPX file 1:
    <input type="file" id="gpx1" accept=".gpx,application/gpx+xml"/>
</label>

<label>
    GPX file 2:
    <input type="file" id="gpx2" accept=".gpx,application/gpx+xml"/>
</label>

<button id="mergeBtn">Merge &amp; Download</button>

<h2>Log</h2>
<pre id="log"></pre>

<script>
    const logEl = document.getElementById('log');
    const mergeBtn = document.getElementById('mergeBtn');

    function log(msg) {
        logEl.textContent += msg + '\n';
        console.log(msg);
    }

    function readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject(reader.error);
            reader.readAsText(file);
        });
    }

    function download(text, filename) {
        const blob = new Blob([text], {type: 'application/gpx+xml'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }

    function mergeGpxStrings(gpx1, gpx2) {
        const parser = new DOMParser();
        const xml1 = parser.parseFromString(gpx1, 'application/xml');
        const xml2 = parser.parseFromString(gpx2, 'application/xml');

        const err1 = xml1.getElementsByTagName('parsererror')[0];
        const err2 = xml2.getElementsByTagName('parsererror')[0];
        if (err1) {
            throw new Error('Error parsing GPX 1: ' + err1.textContent);
        }
        if (err2) {
            throw new Error('Error parsing GPX 2: ' + err2.textContent);
        }

        // Always use file 1 as base
        const merged = xml1.cloneNode(true);
        const mergedRoot = merged.getElementsByTagName('gpx')[0] || merged.documentElement;

        // Info
        const trks1 = xml1.getElementsByTagName('trk');
        const trks2 = xml2.getElementsByTagName('trk');
        const wpts1 = xml1.getElementsByTagName('wpt');
        const wpts2 = xml2.getElementsByTagName('wpt');
        log(`File1: trk=${trks1.length}, wpt=${wpts1.length}`);
        log(`File2: trk=${trks2.length}, wpt=${wpts2.length}`);

        // ---------- merge tracks only if both have at least one ----------
        if (trks1.length > 0 && trks2.length > 0) {
            const trk1 = trks1[0];
            const trk2 = trks2[0];
            const seg1 = trk1.getElementsByTagName('trkseg')[0];
            const seg2 = trk2.getElementsByTagName('trkseg')[0];

            if (seg1 && seg2) {
                const mergedTrk = merged.getElementsByTagName('trk')[0];
                const mergedSeg = mergedTrk.getElementsByTagName('trkseg')[0] || merged.createElement('trkseg');
                if (!mergedTrk.contains(mergedSeg)) {
                    mergedTrk.appendChild(mergedSeg);
                }

                const pts2 = seg2.getElementsByTagName('trkpt');
                log(`Merging ${pts2.length} trackpoints from file 2`);
                for (let i = 0; i < pts2.length; i++) {
                    const imported = merged.importNode(pts2[i], true);
                    mergedSeg.appendChild(imported);
                }
            } else {
                log('One of the tracks has no <trkseg>, skipping track merge.');
            }
        } else {
            log('At least one file has no <trk>, skipping track merge.');
        }

        // ---------- always merge waypoints ----------
        log(`Merging ${wpts2.length} waypoints from file 2`);
        for (let i = 0; i < wpts2.length; i++) {
            const importedWpt = merged.importNode(wpts2[i], true);
            mergedRoot.appendChild(importedWpt);
        }

        const serializer = new XMLSerializer();
        const xmlOut = serializer.serializeToString(merged);
        return xmlOut;
    }

    mergeBtn.addEventListener('click', async () => {
        logEl.textContent = '';
        const file1 = document.getElementById('gpx1').files[0];
        const file2 = document.getElementById('gpx2').files[0];

        if (!file1 || !file2) {
            log('Please select both GPX files.');
            return;
        }

        try {
            log('Reading files...');
            const [text1, text2] = await Promise.all([
                readFileAsText(file1),
                readFileAsText(file2)
            ]);

            log('Merging...');
            const mergedText = mergeGpxStrings(text1, text2);

            log('Starting download...');
            download(mergedText, 'merged.gpx');
            log('Done.');
        } catch (e) {
            console.error(e);
            log('Error: ' + e.message);
        }
    });
</script>
</body>
</html>
